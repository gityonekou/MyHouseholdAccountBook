# マイ家計簿アプリケーション テスト方針書

**作成日**: 2025年11月18日
**対象システム**: MyHouseholdAccountBook
**適用範囲**: 全レイヤー（ドメイン層、アプリケーション層、インフラ層、プレゼンテーション層）

---

## 目次

1. [テスト方針の目的](#1-テスト方針の目的)
2. [テストレベルとカバレッジ目標](#2-テストレベルとカバレッジ目標)
3. [単体テストの方針](#3-単体テストの方針)
4. [統合テストの方針](#4-統合テストの方針)
5. [テストコード品質基準](#5-テストコード品質基準)
6. [テスト命名規則](#6-テスト命名規則)
7. [テストデータ管理](#7-テストデータ管理)
8. [DDDリファクタリング期間中の特別方針](#8-dddリファクタリング期間中の特別方針)

---

## 1. テスト方針の目的

### 1.1 基本方針

**「高品質なテストコードにより、リファクタリングの安全性を担保し、継続的な改善を可能にする」**

### 1.2 期待効果

#### 品質保証
- リファクタリング時の退行バグ防止
- 仕様の明文化とドキュメント化
- 境界値・異常系の網羅的検証

#### 開発効率向上
- 早期バグ検出によるデバッグ時間削減
- 安心してリファクタリングできる環境の構築
- テストコードによる仕様理解の促進

#### 保守性向上
- テストが仕様書として機能
- 変更影響範囲の早期発見
- テストコード自体の可読性・保守性向上

---

## 2. テストレベルとカバレッジ目標

### 2.1 カバレッジ目標

| レイヤー | カバレッジ基準 | 優先度 | 備考 |
|----------|---------------|--------|------|
| **ドメイン層** | **C1網羅 100%必須** | 最高 | 全クラス・全メソッドが対象 |
| アプリケーション層 | C1網羅 80%以上 | 高 | ユースケースクラスが対象 |
| インフラ層 | C0網羅 60%以上 | 中 | リポジトリ実装が主な対象 |
| プレゼンテーション層 | C0網羅 40%以上 | 低 | コントローラーが対象 |

### 2.2 カバレッジ基準の定義

#### C0網羅（命令網羅）
- 全ての実行可能な命令が少なくとも1回は実行される

#### C1網羅（分岐網羅）
- 全ての条件分岐（if文、switch文など）について、true/false両方の分岐が実行される
- **ドメイン層では必須**

### 2.3 テストレベル

```
┌─────────────────────────────────────────┐
│  E2Eテスト（将来的な導入検討）          │
│  - ブラウザ自動化テスト                 │
└─────────────────────────────────────────┘
              ↑
┌─────────────────────────────────────────┐
│  統合テスト（Integration Test）         │
│  - @SpringBootTest使用                  │
│  - 複数レイヤーの結合テスト             │
│  - DB含む実環境に近いテスト             │
└─────────────────────────────────────────┘
              ↑
┌─────────────────────────────────────────┐
│  単体テスト（Unit Test）【最優先】      │
│  - JUnit 5使用                          │
│  - クラス単位のテスト                   │
│  - モック使用最小限                     │
└─────────────────────────────────────────┘
```

---

## 3. 単体テストの方針

### 3.1 ドメイン層の単体テスト【最重要】

#### 3.1.1 対象クラス

- **値オブジェクト（Value Object）**
  - Money、IncomeAmount、ExpenditureAmount、BalanceAmount など
  - 識別子クラス（UserId、IncomeId など）

- **エンティティ（Entity）**
  - 集約ルートを含む全エンティティ

- **ドメインサービス（Domain Service）**
  - 複数の集約にまたがるビジネスロジック

#### 3.1.2 必須テストケース

全てのドメインクラスで以下を必ず実装：

1. **正常系テスト**
   - 基本的な生成・操作のテスト
   - 境界値での動作確認（0、最大値、最小値など）
   - 定数（ZERO など）の検証

2. **異常系テスト**
   - null値のテスト
   - 不正な値のテスト（マイナス値、スケール不正など）
   - ビジネスルール違反のテスト

3. **振る舞いテスト**
   - 加算・減算などの演算メソッド
   - 比較メソッド（compareTo、equals、hashCodeなど）
   - 判定メソッド（isZero、isPositive、isNegativeなど）

4. **不変性テスト**
   - 操作後も元のオブジェクトが変更されていないことの確認

#### 3.1.3 C1網羅（分岐網羅）の必須達成

**ドメイン層のテストでは、全ての分岐を必ずテストすること。**

```java
// 例: 以下のメソッドの場合
public IncomeAmount subtract(IncomeAmount subtractValue) {
    if(subtractValue == null) {  // ← 分岐1
        throw new Exception(...);
    }
    BigDecimal result = super.subtract(subtractValue);

    if(result.compareTo(BigDecimal.ZERO) < 0) {  // ← 分岐2
        throw new Exception(...);
    }
    return new IncomeAmount(result);
}

// 必要なテストケース:
// 1. subtractValue == null → true  (分岐1のtrueパス)
// 2. subtractValue != null && result >= 0 → 正常系 (分岐1のfalse、分岐2のfalse)
// 3. subtractValue != null && result < 0 → 異常系 (分岐1のfalse、分岐2のtrue)
```

#### 3.1.4 テストコード例

```java
@DisplayName("収入金額(IncomeAmount)のテスト")
class IncomeAmountTest {

    @Test
    @DisplayName("正常系：正の金額で生成できる")
    void testFrom_正常系_正の金額() {
        // 実行
        IncomeAmount amount = IncomeAmount.from(new BigDecimal("10000.00"));

        // 検証
        assertNotNull(amount);
        assertEquals(new BigDecimal("10000.00"), amount.getValue());
    }

    @Test
    @DisplayName("異常系：null値で例外が発生する")
    void testFrom_異常系_null値() {
        // 実行 & 検証
        MyHouseholdAccountBookRuntimeException exception = assertThrows(
            MyHouseholdAccountBookRuntimeException.class,
            () -> IncomeAmount.from(null)
        );
        assertTrue(exception.getMessage().contains("収入金額"));
        assertTrue(exception.getMessage().contains("null"));
    }
}
```

### 3.2 アプリケーション層の単体テスト

#### 3.2.1 対象クラス

- ユースケースクラス（~UseCase）

#### 3.2.2 テスト方針

- モックを使用してリポジトリ層を切り離す
- ビジネスロジックの検証に集中
- C1網羅80%以上を目標

### 3.3 インフラ層・プレゼンテーション層

- C0網羅を基本とする
- 複雑なロジックがある場合はC1網羅を検討

---

## 4. 統合テストの方針

### 4.1 対象

- @SpringBootTestを使用した統合テスト
- リポジトリ〜ユースケース〜コントローラーまでの結合

### 4.2 テストデータ

- H2データベース使用
- @Sqlアノテーションでテストデータ投入
- テスト終了後のクリーンアップ

### 4.3 検証内容

- 正常系のエンドツーエンドフロー
- トランザクション境界の確認
- 例外ハンドリングの確認

---

## 5. テストコード品質基準

### 5.1 可読性

#### GIVEN-WHEN-THEN パターンの使用

```java
@Test
void testExample() {
    // GIVEN（準備）
    IncomeAmount amount1 = IncomeAmount.from(new BigDecimal("10000.00"));
    IncomeAmount amount2 = IncomeAmount.from(new BigDecimal("5000.00"));

    // WHEN（実行）
    IncomeAmount result = amount1.add(amount2);

    // THEN（検証）
    assertEquals(new BigDecimal("15000.00"), result.getValue());
}
```

#### コメントによる区切り

```java
// 準備
// 実行
// 検証
```

### 5.2 保守性

- **1テストメソッド＝1検証観点**
- テストメソッドは短く（20行以内が目安）
- 重複コードは@BeforeEachやヘルパーメソッドで共通化
- マジックナンバーを避ける（意味のある定数化）

### 5.3 独立性

- テスト間の依存関係を持たない
- 実行順序に依存しない
- 並列実行可能な設計

### 5.4 高速性

- 単体テストは1クラスあたり1秒以内が目標
- 重い処理はモック化を検討

---

## 6. テスト命名規則

### 6.1 テストクラス名

```
{テスト対象クラス名}Test

例:
- IncomeAmountTest
- MonthlyAccountingUseCaseTest
```

### 6.2 テストメソッド名

#### パターン1: 日本語メソッド名 + @DisplayName（推奨）

```java
@Test
@DisplayName("正常系：正の金額で生成できる")
void testFrom_正常系_正の金額() {
    // ...
}

@Test
@DisplayName("異常系：null値で例外が発生する")
void testFrom_異常系_null値() {
    // ...
}
```

#### 命名規則

```
test{対象メソッド名}_{正常系|異常系}_{テスト観点}

例:
- testFrom_正常系_正の金額
- testFrom_異常系_null値
- testAdd_正常系_加算が正しく動作する
- testSubtract_異常系_結果がマイナス
```

### 6.3 @DisplayName の記述ルール

- 日本語で記述
- 「〜する」「〜できる」など動詞で終わる
- 何をテストしているか一目で分かる表現

---

## 7. テストデータ管理

### 7.1 値オブジェクトのテストデータ

- テストメソッド内で直接生成
- 意味のある値を使用（10000.00 など、キリの良い数値）

### 7.2 統合テストのテストデータ

- SQLファイルで管理
- 配置場所: `src/test/resources/sql/`
- @Sql アノテーションで投入

```java
@SpringBootTest
@Sql(scripts = "/sql/test-data.sql")
class IntegrationTest {
    // ...
}
```

### 7.3 テストデータの原則

- **本番データは使用しない**
- 個人情報を含まない
- 最小限のデータセット
- テスト間でデータを共有しない

---

## 8. DDDリファクタリング期間中の特別方針

### 8.1 新規作成クラスのテスト

**全ての新規ドメインクラスは、C1網羅100%のテストを作成してからコミットする。**

- テストなしでのコミットは禁止
- テストケース作成 → テスト実行 → 全件成功 → コミット

### 8.2 既存クラスの修正

- 修正箇所に関連するテストを追加・修正
- 可能な限りC1網羅を目指す
- 最低限、修正した分岐のテストは必須

### 8.3 テストファースト開発の推奨

Phase 2以降のリファクタリングでは、以下の順序を推奨：

```
1. 仕様の確認
2. テストケースの作成（失敗するテスト）
3. 実装
4. テスト実行（成功確認）
5. リファクタリング
6. テスト実行（退行確認）
```

### 8.4 カバレッジ測定

- Eclipseのカバレッジツール（EclEmma）を使用
- 定期的にカバレッジを測定し、目標達成状況を確認

---

## 補足事項

### テスト方針の見直し

- リファクタリング進捗に応じて本方針書を更新
- Phase完了ごとに振り返りを実施し、改善点を反映

### 参考資料

- [JUnit 5 公式ドキュメント](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito 公式ドキュメント](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- Spring Boot Testing ドキュメント

---

**変更履歴**

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025/11/18 | 1.0.0 | 初版作成（DDDリファクタリング Phase 1開始に伴う作成） |
